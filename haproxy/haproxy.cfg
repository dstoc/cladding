global
    log stdout format raw local0

defaults
    log     global
    mode    http
    option  httplog
    timeout connect 5s
    timeout client  1m
    timeout server  1m

resolvers podman_dns
    nameserver dns1 10.89.0.1:53
    resolve_retries 3
    timeout retry   1s
    hold valid      10s

frontend https_proxy
    bind *:8080
    
    # --- A. IDENTIFY THE CLIENT (Source IP) ---
    # We use placeholders that the startup script will replace with real IPs
    acl src_is_cli     src -i REPLACE_CLI_IP
    acl src_is_sandbox src -i REPLACE_SANDBOX_IP

    # --- B. DEFINE ALLOWED DESTINATIONS ---
    # Normalize Host header: lowercase + strip optional :port, then do domain-boundary matching.
    acl dest_cli_allowed req.hdr(host),lower,field(1,:) -m dom -f /opt/haproxy/cli_domains.lst
    acl dest_sandbox_allowed req.hdr(host),lower,field(1,:) -m dom -f /opt/haproxy/sandbox_domains.lst

    # --- C. ENFORCE RULES ---
    http-request deny if src_is_cli !dest_cli_allowed
    http-request deny if src_is_sandbox !dest_sandbox_allowed
    http-request deny if !src_is_cli !src_is_sandbox

    # --- D. ROUTE ---
    default_backend dynamic_internet

backend dynamic_internet
    http-request do-resolve(txn.dst,podman_dns,ipv4) req.hdr(host),field(1,:)
    http-request set-dst var(txn.dst)
    server clear 0.0.0.0:0
